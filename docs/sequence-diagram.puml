@startuml Coworking_Space_Sequence_Diagram

' ========================================================
'  Coworking Space Booking System — Sequence Diagram
'  Project : be-project-68-cucode
'  Date    : March 2026
' ========================================================

skinparam backgroundColor #FFFFFF
skinparam shadowing false
skinparam defaultFontName "Arial"
skinparam defaultFontSize 11

skinparam sequence {
    ArrowColor #37474F
    ArrowFontSize 10
    ArrowFontColor #546E7A
    LifeLineBorderColor #78909C
    LifeLineBackgroundColor #ECEFF1
    ParticipantBorderColor #37474F
    ParticipantBackgroundColor #E3F2FD
    ParticipantFontColor #0D47A1
    ParticipantFontStyle bold
    ParticipantFontSize 12
    ActorBorderColor #37474F
    ActorFontStyle bold
    GroupBorderColor #90A4AE
    GroupHeaderFontSize 12
    DividerBorderColor #B0BEC5
    DividerFontSize 13
    DividerFontStyle bold
    BoxBorderColor #CFD8DC
    BoxBackgroundColor #FAFAFA
    BoxFontSize 12
}

skinparam note {
    BackgroundColor #FFFDE7
    BorderColor #F9A825
    FontSize 9
}

' ───────── Participants ─────────
actor "Client\n(Postman / Frontend)" as Client
box "Express Server" #F5F5F5
    participant "Router\n& Middleware" as Router
    participant "Auth\nMiddleware" as AuthMW
    participant "Controller" as Ctrl
end box
database "MongoDB\n(Atlas)" as DB

' ══════════════════════════════════════════
'  Scenario 1 : User Registration
' ══════════════════════════════════════════
== **Scenario 1 : Register** ==

Client -> Router : POST /api/v1/auth/register\n{name, tel, email, password, role}
activate Router
Router -> Ctrl : register(req, res)
activate Ctrl
Ctrl -> DB : User.create({name, tel, email, password, role})
activate DB

note right of DB
  pre-save middleware:
  hash password with bcrypt
end note

DB --> Ctrl : user document
deactivate DB

Ctrl -> Ctrl : user.getSignedJwtToken()

note right of Ctrl
  Sign JWT with
  user._id & JWT_SECRET
end note

Ctrl --> Router : res.status(200)\n.cookie("token", jwt)\n.json({success, token})
deactivate Ctrl
Router --> Client : **200 OK**\n{success: true, token: "xxx"}
deactivate Router

' ══════════════════════════════════════════
'  Scenario 2 : User Login
' ══════════════════════════════════════════
== **Scenario 2 : Login** ==

Client -> Router : POST /api/v1/auth/login\n{email, password}
activate Router
Router -> Ctrl : login(req, res)
activate Ctrl

alt Missing email or password
    Ctrl --> Router : res.status(400)\n"Please provide email and password"
    Router --> Client : **400 Bad Request**
else Valid input
    Ctrl -> DB : User.findOne({email})\n.select("+password")
    activate DB
    DB --> Ctrl : user document (with password)
    deactivate DB

    alt User not found
        Ctrl --> Router : res.status(400)\n"Invalid credentials"
        Router --> Client : **400 Bad Request**
    else User found
        Ctrl -> Ctrl : user.matchPassword(password)\nbcrypt.compare()

        alt Password mismatch
            Ctrl --> Router : res.status(401)\n"Invalid credentials"
            Router --> Client : **401 Unauthorized**
        else Password match
            Ctrl -> Ctrl : user.getSignedJwtToken()
            Ctrl --> Router : res.status(200)\n.cookie("token", jwt)\n.json({success, token})
            Router --> Client : **200 OK**\n{success: true, token: "xxx"}
        end
    end
end
deactivate Ctrl
deactivate Router

' ══════════════════════════════════════════
'  Scenario 3 : Create Booking (with Auth)
' ══════════════════════════════════════════
== **Scenario 3 : Create Booking** ==

Client -> Router : POST /api/v1/coworkingspaces/:id/bookings\nHeader: Authorization: Bearer <token>\n{bookingDate}
activate Router

Router -> AuthMW : protect(req, res, next)
activate AuthMW
AuthMW -> AuthMW : Extract token from\nAuthorization header

alt No token or token == null
    AuthMW --> Client : **401** "Not authorized"
else Token exists
    AuthMW -> AuthMW : jwt.verify(token, JWT_SECRET)
    AuthMW -> DB : User.findById(decoded.id)
    activate DB
    DB --> AuthMW : user document
    deactivate DB
    AuthMW -> AuthMW : req.user = user
    AuthMW -> Router : next()
end
deactivate AuthMW

Router -> AuthMW : authorize('admin','user')
activate AuthMW
alt Role not in allowed list
    AuthMW --> Client : **403** "Role not authorized"
else Role allowed
    AuthMW -> Router : next()
end
deactivate AuthMW

Router -> Ctrl : addBooking(req, res)
activate Ctrl

Ctrl -> DB : CoworkingSpace.findById(coworkingspaceId)
activate DB
DB --> Ctrl : coworking space document
deactivate DB

alt Coworking space not found
    Ctrl --> Router : res.status(404)
    Router --> Client : **404 Not Found**
else Coworking space exists
    Ctrl -> DB : Booking.find({user: req.user.id})
    activate DB
    DB --> Ctrl : existedBookings[]
    deactivate DB

    alt User has >= 3 bookings && role != admin
        Ctrl --> Router : res.status(400)\n"Already made 3 bookings"
        Router --> Client : **400 Bad Request**
    else Booking allowed
        Ctrl -> DB : Booking.create({bookingDate,\nuser, coworkingspace})
        activate DB
        DB --> Ctrl : new booking document
        deactivate DB
        Ctrl --> Router : res.status(200)\n{success, data: booking}
        Router --> Client : **200 OK**\n{success: true, data: {...}}
    end
end
deactivate Ctrl
deactivate Router

' ══════════════════════════════════════════
'  Scenario 4 : Delete Coworking Space
'  (Cascade Delete)
' ══════════════════════════════════════════
== **Scenario 4 : Delete Coworking Space (Cascade)** ==

Client -> Router : DELETE /api/v1/coworkingspaces/:id\nHeader: Authorization: Bearer <token>
activate Router

Router -> AuthMW : protect → authorize('admin')
activate AuthMW
AuthMW -> DB : verify token → find user
activate DB
DB --> AuthMW : admin user
deactivate DB
AuthMW -> Router : next()
deactivate AuthMW

Router -> Ctrl : deleteCoworkingSpace(req, res)
activate Ctrl

Ctrl -> DB : CoworkingSpace.findById(id)
activate DB
DB --> Ctrl : coworking space document
deactivate DB

alt Not found
    Ctrl --> Router : res.status(404)
    Router --> Client : **404 Not Found**
else Found
    Ctrl -> DB : coworkingspace.deleteOne()
    activate DB

    note right of DB
      pre-deleteOne middleware:
      Booking.deleteMany({
        coworkingspace: this._id
      })
    end note

    DB -> DB : Cascade delete\nall related bookings
    DB --> Ctrl : deleted
    deactivate DB

    Ctrl --> Router : res.status(200)\n{success: true, data: {}}
    Router --> Client : **200 OK**\n{success: true, data: {}}
end

deactivate Ctrl
deactivate Router

@enduml
